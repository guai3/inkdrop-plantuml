{"version":3,"sources":["../src/generator.js"],"names":["Promise","config","cancellation","getJarPath","vendorDirectory","path","resolve","__dirname","files","fs","readdirSync","jarFiles","filter","file","endsWith","sort","reverse","length","message","Error","join","getLocalImage","code","reject","onCancel","proc","canceled","kill","process","nextTick","stdin","write","end","catch","on","err","getStream","buffer","stdout","then","toString","getServerImage","url","createImageURL","inkdrop","get"],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport * as fs from 'fs';\nimport { encode } from 'plantuml-encoder';\nimport execa from 'execa';\nimport getStream from 'get-stream';\nimport Promise from 'bluebird';\n\nPromise.config({\n  cancellation: true,\n});\n\nfunction getJarPath() {\n  const vendorDirectory = path.resolve(__dirname, '../vendor');\n  const files = fs.readdirSync(vendorDirectory);\n\n  const jarFiles = files\n    .filter(file => file.endsWith('.jar'))\n    .sort()\n    .reverse();\n\n  if (jarFiles.length === 0) {\n    const message = `Please ensure there is a PlantUML jar in ${vendorDirectory}`;\n    throw new Error(message);\n  }\n\n  return path.join(vendorDirectory, jarFiles[0]);\n}\n\nfunction getLocalImage(code) {\n  return new Promise((resolve, reject, onCancel) => {\n    try {\n      const proc = execa('java', [\n        '-jar',\n        '-Djava.awt.headless=true',\n        getJarPath(),\n        '-tpng',\n        '-pipe',\n      ]);\n\n      let canceled = false;\n\n      onCancel(() => {\n        canceled = true;\n        proc.kill();\n      });\n\n      process.nextTick(() => {\n        proc.stdin.write(code);\n        proc.stdin.end();\n      });\n\n      proc.catch(() => {});\n\n      proc.on('error', err => {\n        if (err.code === 'ENOENT') {\n          reject(new Error(`Please make sure Java is available on your PATH.`));\n        } else {\n          reject(err);\n        }\n      });\n\n      getStream\n        .buffer(proc.stdout)\n        .then(buffer => {\n          if (!canceled) {\n            resolve('data:image/png;base64,' + buffer.toString('base64'));\n          }\n        })\n        .catch(err => reject(err.message));\n    } catch (err) {\n      reject(err);\n    }\n  });\n}\n\nfunction getServerImage(code, url) {\n  return Promise.resolve(path.join(url, 'img', encode(code)));\n}\n\nexport function createImageURL(code) {\n  if (inkdrop.config.get('plantuml.mode') === 'Local') {\n    return getLocalImage(code);\n  } else {\n    return getServerImage(code, inkdrop.config.get('plantuml.serverUrl'));\n  }\n}\n"],"file":"generator.js"}